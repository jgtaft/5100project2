<html>
<head>
<title>P2</title>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>

<style>
svg {
  border: solid #ccc 1px;
}

#yearSlider {
  width: 1000px;
}

#legendText {
  text-anchor: middle;
}

#button1{
  width: 5%;
  height: 5%;
  background-color: #4096F2;
  border-radius: 25px;
  border-style: none;
  color: white;
}

#button2{
  width: 5%;
  height: 5%;
  background-color: #EF3B2E;
  border-radius: 25px;
  border-style: none;
  color: white;
}
#info{
  float: right;
  display: inline;
}
#date{
  size: 100pt;
  font-weight: bold;
}
#tooltip{
  z-index: 10000;
}

</style>
</head>
<body>

<div id="date">
</div>
<div id="info">
</div>
<svg id="map"></svg>

<input id="yearSlider" type="range" min="1960" max="2010" value="1960" oninput="showMap(buttonSelection, value)">

<br/>

<button type="button" id="button1" autofocus="TRUE" onclick="showMap('imports', yearSlider.value)">Imports</button>
<button type="button" id="button2" onclick="showMap('exports', yearSlider.value)">Exports</button>
<div id="slider">
</div>
<h2>To think about</h2>
<ul>
  <li> What kind of scale? </li>
  <li> Is there a difference between no data and zero imports/exports?</li>
  <li> Should the scale reflect the min/max number for that year, or the min/max number for the whole dataset?</li>
</ul>
<script>

var height = 500;
var mapWidth = 1000;
var width = 1000;

var map = d3.select("svg#map")
  .attr("width", width)
  .attr("height", height)
  .attr("display", "inline")
  .attr("float", "left");

var projection = d3.geoRobinson();
var pathGenerator = d3.geoPath().projection(projection);

//color scales
// var importColorScale = ["#ffffff", "#E3EEF4", "#C6DDE8", "#AACCDD", "#8EBBD2", "#5599BB", "#71AAC6", "#3988B0", "#1C77A4", "#006699"];
// d3.scaleOrdinal().range(["#4DB6AC", "#48A7C8", "#2D8ED7", "#448AFF", "#22A3EA", "#00BCD4", "#01579b", "#0d4781"])
var importColorScale = ["#ffffff", "#ECF5FE", "#C6E0FB", "#B3D5FA", "#A0CBF8", "#8DC0F7", "#79B6F6", "#66ABF4", "#53A1F3", "#4096F2"];
var exportColorScale = ["#FFFFFF", "#FCDBD9", "#F9B8B3", "#F8A6A0", "#F6948D", "#F5827A", "#F47167", "#F25F54", "#F14D41", "#EF3B2E"];

//global scales, maps, and other stuff
var importScale, exportScale, buttonSelection, importMapping, exportMapping;

//labels that need to be refreshed every time a new button is clicked
var legendLabels = map.append("g");

//parse functions check every value and update the maximum for imports
var maxImports = 0;
var importArr = [];
var parseImports = function(row){
  row.ISO = Number(row.ISO);
  Object.values(row).forEach(function(value,index){
    if(index>1) {
      value = +Math.log(value);
      importArr.push(value);
      if(value>maxImports){ maxImports = value; }
    }
  })
  return row;
}

//and the same for exports
var maxExports = 0;
var exportArr = [];
var parseExports = function(row){
  row.ISO = Number(row.ISO);
  Object.values(row).forEach(function(value,index){
    if(index>1) {
      value = +Math.log(value);
      exportArr.push(value);
      if(value>maxExports){ maxExports = value; }
    }
  })
  return row;
}

d3.queue()
  .defer(d3.json, "world-110m.json")
  .defer(d3.csv, "imports.csv", parseImports)
  .defer(d3.csv, "exports.csv", parseExports)
  .await(function(error, rawCountries, rawImports, rawExports){

    importMap = d3.map(rawImports, function(country){ return country.ISO; });
    exportMap = d3.map(rawExports, function(country){ return country.ISO; });

    //scales are weird. What kind? What kind of min/max?
    //var impMax = d3.max(rawImports, function(d){ return d.yr1960; });
    importScale = d3.scaleOrdinal().domain(importArr).range(importColorScale);

    // var expMax = d3.max(rawExports, function(d){ return d.yr1960; });
    exportScale = d3.scaleOrdinal().domain(exportArr).range(exportColorScale);

    countries = topojson.feature(rawCountries, rawCountries.objects.countries);

    //initialize to imports in 1960.
    showMap("imports", 1960);
  });

//tooltip stuff
var tip = map.append("g")
  .attr("class", "tooltip")
  // .attr("z-index", 1000)
  .style("display", "none");

function tipIn(country){
  tip.style("display", null);

  // tip.append("rect")
  //   .attr("width", 30)
  //   .attr("height", 20)
  //   .attr("fill", "grey")
  //   .style("opacity", 0.6);

  tip.select("#tiptext").remove();

  tip.append("text")
    .attr("id", "tiptext")
    .attr("x", 15)
    .attr("text-anchor", "middle")
    .text("" + country);
}

function tipOut(){
  tip.style("display", "none");
}

function tipMove(){
  var x = d3.mouse(this)[0];
  var y = d3.mouse(this)[1];
  tip.attr("transform", "translate(" + x + "," + y + ")");
}

function showMap(type, year){
  //initialize these first because they need to be accessible
  //later so that the tooltip plots in front of the map
  var importData, exportData;
  //set buttonselection to imports and yearinput to access csv variables
  buttonSelection = type;
  var yearInput = "yr" + year;

  projection.fitExtent([[0,0], [mapWidth, height]], countries);
	pathGenerator = d3.geoPath().projection(projection);

  //make and fill map
	var paths = map.selectAll("path").data(countries.features);
	paths.enter().append("path").attr("class", "country")
	.merge(paths)
  .attr("fill", function (country){
    importData = importMap.get(country.id);
    exportData = exportMap.get(country.id);
    if(type=="imports"){
      if (importData) { return importScale(importData[yearInput]); }
    }
    if(type=="exports"){
      if (exportData) { return exportScale(exportData[yearInput]); }
    }
  })
  .attr("stroke", "#888")
  .attr("d", function (country) {
    return pathGenerator(country);
  })
  .on("mouseover", function(country){
    var importData = importMap.get(country.id);
    // var exportData = exportMap.get(country.id);
    tipIn(importData.Country)
    // if(type=="imports"){
    //   var data = importMap.get(country.id);
    //   tipIn(data.Country);
    //   document.getElementById("info").innerHTML = "Country: " + importData.Country + "<br>" + "Year: " + year + "<br>" + "Import: $" + Math.round(data[yearInput] * 100)/100 + " worth of arms.";
    // }
    // if(type=="exports"){
    //   var data = exportMap.get(country.id);
    //   tipIn(data.Country);
    //   document.getElementById("info").innerHTML = "Country: " + exportData.Country + "<br>" + "Year: " + year + "<br>" + "Export: $" + Math.round(data[yearInput] * 100)/100 + " worth of arms.";
    // }
  })
  .on("mouseout", tipOut)
  .on("mousemove", tipMove);

  document.getElementById("date").innerHTML = "Year: " + year;

}


</script>
</body>
</html>
