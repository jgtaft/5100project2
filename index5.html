<html>
<head>
<title>P2</title>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<link href="https://fonts.googleapis.com/css?family=Oxygen" rel="stylesheet">

<style>
body {
  font-family: 'Oxygen', sans-serif;
}
#yearSlider {
  width: 1000px;
}
#legendText {
  text-anchor: middle;
}
#makemap{
  width: 30%;
  height: 5%;
  background-color: grey;
  border-style: none;
  color: white;
}
#date{
  size: 100pt;
  font-weight: bold;
}
</style>
</head>
<body>
<h2>The World's Armed Forces, 1989-2008</h2>
<p>Choose your data and scale types, and then click the button to make your map.<br/>
  Move the slider to see how the size of each country's military changes over time.<br/>
  Click on a country to learn more about it. </p>
<div id="scales">
Pick a scale type:<br/>
<input type="radio" value="standard" name="scale" checked="checked">standard scale</input><br/>
<input type="radio" value="log" name="scale">log scale</input></div>
<div id="types">
Pick a data type:<br/>
<input type="radio" value="total" name="type" checked="checked">Total armed forces</input><br/>
<input type="radio" value="percent" name="type">armed forces as % labor force</input>
</div>

<button type="button" id="makemap" onclick="chooseMap(yearSlider.value)">Make me a map!</button>

<div id="info"></div>
<svg id="map"></svg>
<div id="date"></div>

<input id="yearSlider" type="range" min="1989" max="2008" value="1989" oninput="chooseMap(value)">

<br/>

<script>
var height = 500;
var mapWidth = 1000;
var width = 1300;
var map = d3.select("svg#map")
  .attr("width", width)
  .attr("height", height)
  .attr("display", "inline")
  .attr("float", "left");
var projection = d3.geoRobinson();
var pathGenerator = d3.geoPath().projection(projection);
//color scales
// var importColorScale = ["#ffffff", "#E3EEF4", "#C6DDE8", "#AACCDD", "#8EBBD2", "#5599BB", "#71AAC6", "#3988B0", "#1C77A4", "#006699"];
// d3.scaleOrdinal().range(["#4DB6AC", "#48A7C8", "#2D8ED7", "#448AFF", "#22A3EA", "#00BCD4", "#01579b", "#0d4781"])
var totalColorScale = ["#ffffff", "#ECF5FE", "#C6E0FB", "#B3D5FA", "#A0CBF8", "#8DC0F7", "#79B6F6", "#66ABF4", "#53A1F3", "#4096F2"];
var percentColorScale = ["#FFFFFF", "#FCDBD9", "#F9B8B3", "#F8A6A0", "#F6948D", "#F5827A", "#F47167", "#F25F54", "#F14D41", "#EF3B2E"];
//global scales
var totalStandard, percentStandard, totalLog, percentLog;
//global radio button state variables
var scale, type;

//parse functions check every value and update the maximum for each
var maxTotal = 0;
var totalArr = [];
var parseTotal = function(row){
  row.ISO = Number(row.ISO);
  Object.values(row).forEach(function(value,index){
    if(index<20) {
      value = Number(value);
      totalArr.push(value);
      if(value>maxTotal){ maxTotal = value; }
    }
  })
  return row;
}
//and the same for exports
var maxPercent = 0;
var percentArr = [];
var parsePercent = function(row){
  row.ISO = Number(row.ISO);
  Object.values(row).forEach(function(value,index){
    if(index<20) {
      value = Number(value);
      percentArr.push(value);
      if(value>maxPercent){ maxPercent = value; }
    }
  })
  return row;
}

d3.queue()
  .defer(d3.json, "world-110m.json")
  .defer(d3.csv, "forcesTotal.csv", parseTotal)
  .defer(d3.csv, "forcesPercent.csv", parsePercent)
  .await(function(error, rawCountries, rawTotal, rawPercent){
    totalMap = d3.map(rawTotal, function(country){ return country.ISO; });
    percentMap = d3.map(rawPercent, function(country){ return country.ISO; });

    //scale options
    totalStandard = d3.scaleQuantize().domain([0, maxTotal]).range(totalColorScale);
    percentStandard = d3.scaleQuantize().domain([0, maxPercent]).range(percentColorScale);
    totalLog = d3.scaleQuantize().domain([0, Math.log(maxTotal)]).range(totalColorScale);
    percentLog = d3.scaleQuantize().domain([0, Math.log(maxPercent)]).range(percentColorScale);

    countries = topojson.feature(rawCountries, rawCountries.objects.countries);
  });

function chooseMap(year){
  var scaleSelect = document.getElementsByName("scale");
  for (var i=0; i<scaleSelect.length; i++){
    if (scaleSelect[i].checked){
      scale = scaleSelect[i].value;
    }
  }
  var typeSelect = document.getElementsByName("type");
  for (var i=0; i<typeSelect.length; i++){
    if (typeSelect[i].checked){
      type = typeSelect[i].value;
    }
  }

  showMap(scale, type, year)
}

function showMap(scale, type, year){
  map.selectAll("#popup").remove();

  //make and fill map
  projection.fitExtent([[0,0], [mapWidth, height]], countries);
	pathGenerator = d3.geoPath().projection(projection);
	var paths = map.selectAll("path").data(countries.features);
	paths.enter().append("path").attr("class", "country")
	.merge(paths)
  .attr("fill", function (country){
    if(type=="total"){
      var data = totalMap.get(country.id);
      if(scale=="log"){
        return data ? totalLog(Math.log(data[year])) : "#888";
      }else if(scale=="standard"){
        return data ? totalStandard(data[year]) : "#888";
      }
    } else if(type=="percent"){
      var data = percentMap.get(country.id);
      if(scale=="log"){
        return data ? percentLog(Math.log(data[year])) : "#888";
      }else if(scale=="standard"){
        return data ? percentStandard(data[year]) : "#888";
      }
    }
  })
  .attr("stroke", "#888")
  .attr("d", function (country) {
    return pathGenerator(country);
  })
  .on("click", function(country){
    var totalData = totalMap.get(country.id);
    var percentData = percentMap.get(country.id);
    showInfo(year, totalData[year], percentData[year], percentData.Country, d3.mouse(this));
  })
  .transition().attr("duration", 200);//this isnt working for some reason

  showGradient(scale, type);
  document.getElementById("date").innerHTML = "Year: " + year + " ";
}

function showGradient(scale, type){
  d3.select("#gradient").remove();
  d3.select("#legendText").remove();

  //add sidebar gradient. code from: https://bl.ocks.org/mbostock/1086421
  var gradient = map.append("defs")
  .append("linearGradient")
    .attr("id", "gradient")
    .attr("x1", "50%")
    .attr("y1", "0%")
    .attr("x2", "50%")
    .attr("y2", "100%")
    .attr("spreadMethod", "pad");

  gradient.append("stop")
    .attr("offset", "100%")
    .attr("stop-color", "#fff");

  var gradientRect = map.append("rect")
      .attr("width", 30)
      .attr("height", 400)
      .attr("x", 20)
      .attr("y", 48)
      .attr("stroke", "#888");

  //labels that need to be refreshed every time a new button is clicked
  var legendLabels = map.append("g")
    .attr("id", "legend");

  legendLabels.append("text")
    .attr("id", "legendText")
    .attr("x", 35)
    .attr("y", 40);

  legendLabels.append("text")
    .attr("x", 55)
    .attr("y", 60)
    .text("0");
  legendLabels.append("text")
    .attr("id", "endLabel")
    .attr("x", 55)
    .attr("y", 445);

  if(type=="total"){
    gradient.append("stop")
      .attr("id", "end")
      .attr("offset", "0%")
      .attr("stop-color", "#4096F2")
    d3.select("#legendText").text("Number");
    d3.select("#endLabel").text(Math.round(maxTotal * 100)/100);
  }else{
    gradient.append("stop")
      .attr("id", "end")
      .attr("offset", "0%")
      .attr("stop-color", "#EF3B2E");
    d3.select("#legendText").text("Percent");
    d3.select("#endLabel").text(Math.round(maxPercent * 100)/100 + "%");
  }

  gradientRect.attr("fill", "url(#gradient)");

}

function showInfo(year, total, percent, country, coords){
  var x = coords[0];
  var y = coords[1];
  map.selectAll("#popup").remove();
  var popup = map.append("g")
    .attr("id", "popup");
  popup.append("path")
    .attr("x", x)
    .attr("y", y)
    .attr("d", "m " + x + " " + y + " l 25 -50 v 100 z")
    .attr("fill", "#d6d6d6");
  popup.append("rect")
    .attr("height", 100)
    .attr("width", 260)
    .attr("x", x + 25)
    .attr("y", y - 50)
    .attr("fill", "#d6d6d6");
  popup.append("text")
    .attr("id", "name")
    .attr("x", x + 30)
    .attr("y", y - 30)
    .text(country);
  if(total=="" || percent ==""){
    popup.append("text")
      .attr("x", x + 30)
      .attr("y", y - 5)
      .text("No data for " + country + " in " + year + ".")
  }else{
    var lines = ["In " + year + ", " + country + " had "+ total, " people in its armed forces,", "or " + Math.round(percent*10)/10 + "% of its labor force."]
    for(var i=0; i< lines.length; i++){
      popup.append("text")
        .attr("x", x + 30)
        .attr("y", y -5 + (20*i))
        .text(lines[i]);
    }
  }
}
</script>
</body>
</html>
