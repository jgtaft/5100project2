<html>
<head>
<title>P2</title>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<link href="https://fonts.googleapis.com/css?family=Bitter" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Assistant" rel="stylesheet">

<style>
body {
  font-family: 'Assistant', sans-serif;
}
h1,h3{
  font-family: 'Bitter', serif;
}
#yearSlider {
  width: 1000px;
}
#legendText {
  text-anchor: middle;
}
#date{
  size: 100pt;
  font-weight: bold;
}
#types{
  margin: 5 5 5 5;
  float:left;
  text-align: left;
}
#line{
  margin-top: 20;
  margin-bottom: 20;
  stroke: #888;
}
.tick{
  font-size: 15pt;
  stroke-width: 4;
}
.domain{
  stroke-width: 4;
}
#button1{
  width: 20%;
  height: 5%;
  background-color: #4096F2;
  border-style: none;
  color: white;
  margin-top:20;
  margin-bottom: 20;
}
#button2{
  width: 20%;
  height: 5%;
  background-color: #EF3B2E;
  border-style: none;
  color: white;
  margin-top:20;
  margin-bottom: 20;
}

</style>
</head>
<body>
<h1>The Scale of the World's Militaries</h1>
<h4>Nearly every country in the world spends a significant amount of money and labor
  on staffing and supplying its armed forces. <br> It makes sense that larger countries
have larger militaries, and richer countries spend more on their miltaries.<br>
But showing these differences on different scales can give us a clearer picture
of who devotes what resources to maintaining their military power.</h4>
<svg id="line" height="5" width="1000">
  <line x1="0" y1="2" x2="1000" y2="2" stroke-width="2">
</svg>
<h3>Part 1: Military Size</h3>
<p>Choose your data type, and then choose a scale to make your map.<br>
  Move the slider to see how the size of each country's military changes over time.<br>
  Click on a country to learn more about it. </p>

<div id="types">
Pick a data type:<br/>
<input type="radio" value="total" name="type" checked="checked">Total Armed Forces</input><br/>
<input type="radio" value="percent" name="type">Armed Forces as % of Labor Force</input>
</div>
<br/>
<br/>
<br/>
<br/>
<button type="button" id="button1" onclick="showMap('standard', yearSlider.value)">Show on Standard Scale</button>
<button type="button" id="button2" onclick="showMap('log', yearSlider.value)">Show on Log Scale</button>

<svg id="map"></svg>
<div id="date"></div>

<input id="yearSlider" type="range" min="1989" max="2008" value="1989" oninput="showMap(scaleSelection, value)">

<br/>

<script>
var height = 500;
var mapWidth = 1000;
var width = 1300;
var map = d3.select("svg#map")
  .attr("width", width)
  .attr("height", height)
  .attr("display", "inline")
  .attr("float", "left");
var projection = d3.geoRobinson();
var pathGenerator = d3.geoPath().projection(projection);
//blue scale
var standardColorScale = ["#ffffff", "#ECF5FE", "#C6E0FB", "#B3D5FA", "#A0CBF8", "#8DC0F7", "#79B6F6", "#66ABF4", "#53A1F3", "#4096F2"];
//red scale
var logColorScale = ["#FFFFFF", "#FCDBD9", "#F9B8B3", "#F8A6A0", "#F6948D", "#F5827A", "#F47167", "#F25F54", "#F14D41", "#EF3B2E"];
//global scales
var totalStandard, percentStandard, totalLog, percentLog;
//global radio button state variable
var type, scaleSelection;

//parse functions check every value and update the maximum for each
var maxTotal = 0;
var parseTotal = function(row){
  row.ISO = Number(row.ISO);
  Object.values(row).forEach(function(value,index){
    if(index<20) {
      value = Number(value);
      if(value>maxTotal){ maxTotal = value; }
    }
  })
  return row;
}
//and the same for exports
var maxPercent = 0;
var parsePercent = function(row){
  row.ISO = Number(row.ISO);
  Object.values(row).forEach(function(value,index){
    if(index<20) {
      value = Number(value);
      if(value>maxPercent){ maxPercent = value; }
    }
  })
  return row;
}

d3.queue()
  .defer(d3.json, "world-110m.json")
  .defer(d3.csv, "forcesTotal.csv", parseTotal)
  .defer(d3.csv, "forcesPercent.csv", parsePercent)
  .await(function(error, rawCountries, rawTotal, rawPercent){
    totalMap = d3.map(rawTotal, function(country){ return country.ISO; });
    percentMap = d3.map(rawPercent, function(country){ return country.ISO; });

    //scale options
    totalStandard = d3.scaleQuantize().domain([0, maxTotal]).range(standardColorScale).nice();
    percentStandard = d3.scaleQuantize().domain([0, maxPercent]).range(standardColorScale).nice();
    totalLog = d3.scaleQuantize().domain([0, Math.log(maxTotal)]).range(logColorScale).nice();
    percentLog = d3.scaleQuantize().domain([0, Math.log(maxPercent)]).range(logColorScale).nice();

    countries = topojson.feature(rawCountries, rawCountries.objects.countries);

    showMap("standard", 1989);
  });

function showMap(scale, year){
  //set the type radio button variable
  var typeSelect = document.getElementsByName("type");
  for (var i=0; i<typeSelect.length; i++){
    if (typeSelect[i].checked){
      type = typeSelect[i].value;
    }
  }

  scaleSelection = scale;
  map.selectAll("#popup").remove();
  map.selectAll("#labels").remove();

  //make and fill map
  projection.fitExtent([[0,0], [1000, 500]], countries);
	pathGenerator = d3.geoPath().projection(projection);
	var paths = map.selectAll("path").data(countries.features);
	paths.enter().append("path").attr("class", "country")
	.merge(paths)
  .attr("fill", function (country){
    if(scale=="log"){
      if(type=="total"){
        var data = totalMap.get(country.id);
        return data ? totalLog(Math.log(data[year])) : "#888";
      }else if(type=="percent"){
        var data = percentMap.get(country.id);
        return data ? percentLog(Math.log(data[year])) : "#888";
      }
    } else if(scale=="standard"){
      if(type=="total"){
        var data = totalMap.get(country.id);
        return data ? totalStandard(data[year]) : "#888";
      }else if(type=="percent"){
        var data = percentMap.get(country.id);
        return data ? percentStandard(data[year]) : "#888";
      }
    }
  })
  .attr("stroke", "#888")
  .attr("d", function (country) {
    return pathGenerator(country);
  })
  .on("click", function(country){
    var totalData = totalMap.get(country.id);
    var percentData = percentMap.get(country.id);
    showInfo(year, totalData[year], percentData[year], percentData.Country, d3.mouse(this));
  })
  .transition().attr("duration", 200);//this isnt working for some reason

  document.getElementById("date").innerHTML = "Year: " + year + " ";
  makeLegend(type, scale);
}

function makeLegend(type, scale){
  if(scale=="log"){
    for(var i=0; i<logColorScale.length; i++){
      map.append("rect")
      .attr("x", 30)
      .attr("y", 230 + (25*i))
      .attr("width", 20)
      .attr("height", 20)
      .attr("stroke", "#888")
      .attr("fill", logColorScale[i]);
    }
  }else if(scale=="standard"){
    for(var i=0; i<standardColorScale.length; i++){
      map.append("rect")
      .attr("x", 30)
      .attr("y", 230 + (25*i))
      .attr("width", 20)
      .attr("height", 20)
      .attr("stroke", "#888")
      .attr("fill", standardColorScale[i]);
    }
  }

  var labels = map.append("g")
    .attr("id", "labels");

  labels.append("text")
    .attr("x", 60)
    .attr("y", 245)
    .text("0");

  if(type=="total"){
    labels.append("text")
      .attr("x", 55)
      .attr("y", 245 + (25 * 9))
      .text(totalStandard.domain()[1] + " people");

    labels.append("text")
      .attr("x", 30)
      .attr("y", 225)
      .text("Number of People")
  }
  if(type=="percent"){
    labels.append("text")
      .attr("x", 55)
      .attr("y", 245 + (25 * 9))
      .text(percentStandard.domain()[1] + " %");

    labels.append("text")
      .attr("x", 30)
      .attr("y", 225)
      .text("Percent of Labor Force")
  }
}

function showInfo(year, total, percent, country, coords){
  var x = coords[0];
  var y = coords[1];
  map.selectAll("#popup").remove();
  var popup = map.append("g")
    .attr("id", "popup");
  popup.append("path")
    .attr("x", x)
    .attr("y", y)
    .attr("d", "m " + x + " " + y + " l 25 -50 v 100 z")
    .attr("fill", "black")
    .attr("opacity", 0.9);
  popup.append("rect")
    .attr("height", 100)
    .attr("width", 260)
    .attr("x", x + 25)
    .attr("y", y - 50)
    .attr("fill", "black")
    .attr("opacity", 0.9);
  popup.append("text")
    .attr("id", "name")
    .attr("x", x + 30)
    .attr("y", y - 30)
    .attr("fill", "white")
    .text(country);
  if(total=="" || percent ==""){
    popup.append("text")
      .attr("x", x + 30)
      .attr("y", y - 5)
      .attr("fill", "white")
      .text("No data for " + country + " in " + year + ".")
  }else{
    var lines = ["In " + year + ", " + country + " had "+ total, " people in its armed forces,", "or " + Math.round(percent*10)/10 + "% of its labor force."]
    for(var i=0; i< lines.length; i++){
      popup.append("text")
        .attr("x", x + 30)
        .attr("y", y -5 + (20*i))
        .attr("fill", "white")
        .text(lines[i]);
    }
  }
}
</script>
<svg id="line" height="5" width="1000">
  <line x1="0" y1="2" x2="1000" y2="2" stroke-width="2">
</svg>
<h3> Part 2: Military Spending</h3>
<p> Choose a scale to see the military expenditure for the countries with the five highest
  and lowest gross domestic products (GDPs).</p>
<svg id="graph" width="1000" height="500"></svg>
<div id="buttons">
	<button type="button" id="button1" onclick="showGraph('normal')">Military Expenditure Normal Scale</button>
	<button type="button" id="button2" onclick="showGraph('log')">Military Expenditure Log Scale</button>
<div>
<script>

var buttonSelect;

//code from https://bl.ocks.org/mbostock/3887051 for lines 65-347
var svg = d3.select("svg#graph"),
    margin = {top: 50, right: 20, bottom: 25, left: 60},
    width = +svg.attr("width") - margin.left - margin.right,
    height = +svg.attr("height") - margin.top - margin.bottom,
    g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var x0 = d3.scaleBand()
    .rangeRound([0, width])
    .paddingInner(0.1);

var x1 = d3.scaleBand()
    .padding(0.05);

var y = d3.scaleLinear()
    .rangeRound([height, 0]);

// Define the div for the tooltip
var div = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

showNormal();

// function for when buttons are clicked to switch frclick the button to
function showGraph(type){
	buttonSelect = type;
	if(type == "normal"){
		showNormal();
	} else if (type == "log"){
		showLog();
	}
}

// function to show the normal scale graph
function showNormal(){
	//setting the color to match the blue color in other graph
	var colors = d3.scaleOrdinal().range(["#A0CBF8", "#8DC0F7", "#79B6F6", "#66ABF4", "#53A1F3", "#4096F2"]);

	//collection data form csv file
	d3.csv("DataExpend.csv", function(d, i, columns) {
		//parsing out the data by column to help gather country and year data
	    for (var i = 1, n = columns.length; i < n; ++i)
	    d[columns[i]] = +(d[columns[i]]);
	    return d;
	  }, function(error, data) {
	    if (error) throw error;

	    //collecting all the years form the data set and making it an array
	    var years = data.columns.slice(1);
	    //console.log(years);

	    //setting the x domain to the countries in the data set
	    x0.domain(data.map(function(d) {
	      return d.CountryExpend;
	    }));
	    // second x domain because showing five graphs per country
	    x1.domain(years).rangeRound([0, x0.bandwidth()]);
	    // setting y domain based on the values for each year
	    y.domain([0, d3.max(data, function(d) {
	      return d3.max(years, function(years) {
	        return d[years];
	      });
	    })]).nice();

	    // appending to g
	    g.append("g")
	      .selectAll("g")
	      .data(data)
	      .enter().append("g")
	      	//translating/transforming spot where each area for each country will be in the graph
	        .attr("transform", function(d) {
	          return "translate(" + x0(d.CountryExpend) + ",0)";
	        })
	      .selectAll("rect")
	      .data(function(d) {
	      	//collecting the data and maping country, years and values for country to create rectangles
	        return years.map(function(years) {
	          return {years: years, value: d[years], country: d.CountryExpend};
	          });
	        })
	      	// creating rectangles based on above with x value year and y value value of the specific year. Appending it so it all clusters together
	      	// for each country
	      .enter().append("rect")
	        .attr("x", function(d) {
	          return x1(d.years);
	        })
	        .attr("y", function(d) {
	          return y(d.value);
	        })
	        .attr("width", x1.bandwidth())
	        .attr("height", function(d) {
	          return height - y(d.value);
	        })
	        .attr("fill", function(d) {
	          return colors(d.years);
	        })
	        //code from: http://bl.ocks.org/d3noob/a22c42db65eb00d4e369
	        .on("mouseover", function(d) {
	            div.transition()
	                .duration(200)
	                .style("opacity", .9);
	            div	.html((d.country)+": "+(d.years)+"<br>"+"$"+(d.value))
	                .style("left", (d3.event.pageX) + "px")
	                .style("top", (d3.event.pageY - 28) + "px")
	                .style("position", "absolute")
	                .style("text-anchor", "middle")
	                .style("text-align", "center")
	                .style("width", 110 +"px")
	                .style("display", "block")
	                .style("padding-top", 3+"px")
	                .style("margin", "auto")
	                .style("height", 30+"px")
	                .style("color", "white")
	                .style("font-family", "Assistant")
	                .style("font-size", 10)
	                .style("background", "black")
	                .style("border", 0+"px")
	                .style("border-radius", 8+"px")
	                .style("pointer-events", "none");
            })
	        .on("mouseout", function(d) {
	            div.transition()
	                .duration(200)
	                .style("opacity", 0);
	        });

	    //creating x axis
	    g.append("g")
	        .attr("class", "axis")
	        .attr("transform", "translate(0," + height + ")")
	        .call(d3.axisBottom(x0));

	    // creating y axis with hashes
	    g.append("g")
	        .attr("class", "axis")
	        .call(d3.axisLeft(y).ticks(null, "s"));

	    //creating x axis labels
	    svg.append("text")
	    	.attr("class", "axisLabels")
	      .attr("transform","translate(" + (width/2) + " ," + (height + margin.top + 40) + ")")
	      .style("text-anchor", "middle")
	      .style("font-size", 10)
	      .style("font-weight", "bold")
	      .style("font-family", "Assistant")
	      .text("Country");

		//creating y-axis labels
	    svg.append("text")
	    	.attr("class", "axisLabels")
	      .attr("transform", "rotate(-90)")
	      .attr("y", 0 - margin.right + 20)
	      .attr("x",0 - (height / 2) -40)
	      .attr("dy", "1em")
	      .style("text-anchor", "middle")
	      .style("font-size", 10)
	      .style("font-weight", "bold")
	      .style("font-family", "Assistant")
	      .text("Military Expenditure in $USD");

	    //creating title for graph
	    svg.append("text")
	    	.attr("class", "axisLabels")
		    .attr("font-family", "Assistant")
		    .attr("text-anchor", "top")
		    .attr("text-align", "center")
		    .attr("font-weight", "bold")
		    .attr("font-size", 20)
		    .attr("x", width/2-200)
		    .attr("y", 35)
		    .text("Military Expenditure Based on GDP in $USD (Normal Scale)");

	    // creating the legend for the graph with colors that match year
	    var legend = g.append("g")
	      .attr("font-family", "Assistant")
	      .attr("font-size", 10)
	      .attr("text-anchor", "end")
	    .selectAll("g")
	    .data(years.slice().reverse())
	    .enter().append("g")
	      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

	      //creating rectangles filled with color matching bar rectangles
		  legend.append("rect")
		      .attr("x", width - 19)
		      .attr("width", 19)
		      .attr("height", 19)
		      .attr("fill", colors);

		  //creating text for each rectangle in legend
		  legend.append("text")
		      .attr("x", width - 24)
		      .attr("y", 9.5)
		      .attr("dy", "0.32em")
		      .text(function(d) { return d; });

	});
	//Help from: http://bl.ocks.org/juan-cb/ab9a30d0e2ace0d2dc8c
	// removing axis and rectangles so graph will update based on the button selected
	svg.selectAll("rect")
        .remove()
        .exit();
    svg.selectAll(".axis")
    	.remove()
    	.exit();
   	svg.selectAll(".axisLabels")
   		.remove()
   		.exit();

}
function showLog(){
	var colors = d3.scaleOrdinal().range(["#F6948D", "#F5827A", "#F47167", "#F25F54", "#F14D41", "#EF3B2E"]);
		//collection data form csv file
	d3.csv("DataExpend.csv", function(d, i, columns) {
		//parsing out the data by column to help gather country and year data
	    for (var i = 1, n = columns.length; i < n; ++i)
	    d[columns[i]] = +Math.log(d[columns[i]]);
	    return d;
	  }, function(error, data) {
	    if (error) throw error;

	    //collecting all the years form the data set and making it an array
	    var years = data.columns.slice(1);
	    //console.log(years);

	    //setting the x domain to the countries in the data set
	    x0.domain(data.map(function(d) {
	      return d.CountryExpend;
	    }));
	    // second x domain because showing five graphs per country
	    x1.domain(years).rangeRound([0, x0.bandwidth()]);
	    // setting y domain based on the values for each year
	    y.domain([0, d3.max(data, function(d) {
	      return d3.max(years, function(years) {
	        return d[years];
	      });
	    })]).nice();

	    // appending to g
	    g.append("g")
	      .selectAll("g")
	      .data(data)
	      .enter().append("g")
	      	//translating/transforming spot where each area for each country will be in the graph
	        .attr("transform", function(d) {
	          return "translate(" + x0(d.CountryExpend) + ",0)";
	        })
	      .selectAll("rect")
	      .data(function(d) {
	      	//collecting the data and maping years and values for country to create rectangles
	        return years.map(function(years) {
	          return {years: years, value: d[years], country: d.CountryExpend};
	          });
	        })
	      	// creating rectangles based on above with x value year and y value value of the specific year. Appending it so it all clusters together
	      	// for each country
	      .enter().append("rect")
	        .attr("x", function(d) {
	          return x1(d.years);
	        })
	        .attr("y", function(d) {
	          return y(d.value);
	        })
	        .attr("width", x1.bandwidth())
	        .attr("height", function(d) {
	          return height - y(d.value);
	        })
	        .attr("fill", function(d) {
	          return colors(d.years);
	        })
	        //code from: http://bl.ocks.org/d3noob/a22c42db65eb00d4e369
	        .on("mouseover", function(d) {
	            div.transition()
	                .duration(200)
	                .style("opacity", .9);
	            div	.html("Log Scale" +"<br>"+(d.country)+": "+(d.years)+"<br>"+"$"+(Math.round(Math.exp(d.value))))
	                .style("left", (d3.event.pageX) + "px")
	                .style("top", (d3.event.pageY - 28) + "px")
	                .style("position", "absolute")
	                .style("text-anchor", "middle")
	                .style("text-align", "center")
	                .style("width", 130 +"px")
	                .style("display", "block")
	                .style("padding-top", 3+"px")
	                .style("margin", "auto")
	                .style("height", 40+"px")
	                .style("color", "white")
	                .style("font-family", "Assistant")
	                .style("font-size", 10)
	                .style("background", "black")
	                .style("border", 0+"px")
	                .style("border-radius", 8+"px")
	                .style("pointer-events", "none");
            })
	        .on("mouseout", function(d) {
	            div.transition()
	                .duration(200)
	                .style("opacity", 0);
	        });
	    //creating x axis
	    g.append("g")
	        .attr("class", "axis")
	        .attr("transform", "translate(0," + height + ")")
	        .call(d3.axisBottom(x0));

	    // creating y axis with hashes
	    g.append("g")
	        .attr("class", "axis")
	        .call(d3.axisLeft(y).ticks(null, "s"));

	    //creating x axis labels
	    svg.append("text")
	    .attr("class", "axisLabels")
	      .attr("transform","translate(" + (width/2) + " ," + (height + margin.top + 40) + ")")
	      .style("text-anchor", "middle")
	      .style("font-size", 10)
	      .style("font-weight", "bold")
	      .style("font-family", "Assistant")
	      .text("Country");

		//creating y-axis labels
	    svg.append("text")
	    .attr("class", "axisLabels")
	      .attr("transform", "rotate(-90)")
	      .attr("y", 0 - margin.right + 20)
	      .attr("x",0 - (height / 2) -40)
	      .attr("dy", "1em")
	      .style("text-anchor", "middle")
	      .style("font-size", 10)
	      .style("font-weight", "bold")
	      .style("font-family", "Assistant")
	      .text("Log of Military Expenditure in $USD");

	    //creating title for graph
	    svg.append("text")
	    	.attr("class", "axisLabels")
		    .attr("font-family", "Assistant")
		    .attr("text-anchor", "top")
		    .attr("text-align", "center")
		    .attr("font-weight", "bold")
		    .attr("font-size", 20)
		    .attr("x", width/2-200)
		    .attr("y", 35)
		    .text("Military Expenditure Based on GDP in $USD (Log Scale)");

	    // creating the legend for the graph with colors that match year
	    var legend = g.append("g")
	      .attr("font-family", "Assistant")
	      .attr("font-size", 10)
	      .attr("text-anchor", "end")
	    .selectAll("g")
	    .data(years.slice().reverse())
	    .enter().append("g")
	      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

	      //creating rectangles filled with color matching bar rectangles
		  legend.append("rect")
		      .attr("x", width - 19)
		      .attr("width", 19)
		      .attr("height", 19)
		      .attr("fill", colors);

		  //creating text for each rectangle in legend
		  legend.append("text")
		      .attr("x", width - 24)
		      .attr("y", 9.5)
		      .attr("dy", "0.32em")
		      .text(function(d) { return d; });

	});
	//Help from: http://bl.ocks.org/juan-cb/ab9a30d0e2ace0d2dc8c
	// removing axis and rectangles so graph will update based on the button selected
	svg.selectAll("rect")
        .remove()
        .exit();
    svg.selectAll(".axis")
    	.remove()
    	.exit();
   	svg.selectAll(".axisLabels")
   	 	.remove()
   	 	.exit();
}

</script>
<svg id="line" height="5" width="1000">
  <line x1="0" y1="2" x2="1000" y2="2" stroke-width="2">
</svg>
</body>
</html>
