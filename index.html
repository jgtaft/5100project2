<html>
<head>
<title>P2</title>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>

<style>
svg { 
  border: solid #ccc 1px;
}
#yearSlider { 
  width: 1000px; 
  margin-left: 50px; 
}
#legendText { 
  text-anchor: middle; 
}
button { 
  text-align: center; 
  color: white; 
  padding: 15px 212px; 
  font-size: 20; 
  border:none; 
  width: 5%;
  height: 5%;
  border-radius: 25px;
  border-style: none;
  color: white;
}
#importButton { 
  background-color: #006699; 
  margin: 5px 5px 5px 50px; 
}
#exportButton { 
  background-color: #990000; 
  margin: 5px 5px 5px 5px; 
}
#info{
  float: right;
  display: inline;
}
#date{
  size: 100pt;
  font-weight: bold;
}
</style>
</head>
<body>
<div id="date">
</div>
<div id="info">
</div>
<svg id="map"></svg>
<br/>
<button type="button" id="importButton" onclick="showMap('imports', yearSlider.value)">Imports</button>
<button type="button" id="exportButton" onclick="showMap('exports', yearSlider.value)">Exports</button>
<br/>
<input id="yearSlider" type="range" min="1960" max="2010" value="1960" oninput="showMap(buttonSelection, value)">
<svg id="slider" height="30" width="1050"></svg>
<br/>
<svg id="timeline" height="500" width="1000"></svg>

<h2>To think about</h2>
<ul>
  <li> What kind of scale? </li>
  <li> Is there a difference between no data and zero imports/exports?</li>
  <li> Should the scale reflect the min/max number for that year, or the min/max number for the whole dataset?</li>
  <li>If using the wars data, what gets to count as a war? <a href="http://www.warscholar.org/1975.html">There are so many.</a></li>
</ul>

<script>
var height = 500;
var mapWidth = 1050;
var width = 1500

var map = d3.select("svg#map")
  .attr("width", mapWidth)
  .attr("height", height);

var projection = d3.geoRobinson();
var pathGenerator = d3.geoPath().projection(projection);

//color scales
//var importColorScale = ["#ffffff", "#E3EEF4", "#C6DDE8", "#AACCDD", "#8EBBD2", "#5599BB", "#71AAC6", "#3988B0", "#1C77A4", "#006699"];
//var exportColorScale = ["#FFFFFF", "#F4E3E3", "#E8C6C6", "#DDAAAA", "#D28E8E", "#C67171", "#BB5555", "#B03939", "#A41C1C", "#990000"]
var importColorScale = ["#ffffff", "#ECF5FE", "#C6E0FB", "#B3D5FA", "#A0CBF8", "#8DC0F7", "#79B6F6", "#66ABF4", "#53A1F3", "#4096F2"];
var exportColorScale = ["#FFFFFF", "#FCDBD9", "#F9B8B3", "#F8A6A0", "#F6948D", "#F5827A", "#F47167", "#F25F54", "#F14D41", "#EF3B2E"];

//global scales, maps, and other stuff
var importScale, exportScale, buttonSelection, importMapping, exportMapping;

//get ready for sidebar gradient. code from: https://bl.ocks.org/mbostock/1086421
var gradient = map.append("defs")
.append("linearGradient")
  .attr("id", "gradient")
  .attr("x1", "50%")
  .attr("y1", "0%")
  .attr("x2", "50%")
  .attr("y2", "100%")
  .attr("spreadMethod", "pad");

gradient.append("stop")
  .attr("offset", "0%")
  .attr("stop-color", "#fff");

gradient.append("stop")
  .attr("id", "end")
  .attr("offset", "100%");

var gradientRect = map.append("rect")
    .attr("width", 30)
    .attr("height", 470)
    .attr("x", 20)
    .attr("y", 30)
    .attr("stroke", "#888");

//labels that need to be refreshed every time a new button is clicked
var legendLabels = map.append("g");

//parse functions check every value and update the maximum for imports
var maxImports = 0;
var importArr = [];
var parseImports = function(row){
  row.ISO = Number(row.ISO);
  Object.values(row).forEach(function(value,index){
    if(index>1) {
      value = +Math.log(value);
      importArr.push(value);
      if(value>maxImports){ maxImports = value; }
    }
  })
  return row;
}

//and the same for exports
var maxExports = 0;
var exportArr = [];
var parseExports = function(row){
  row.ISO = Number(row.ISO);
  Object.values(row).forEach(function(value,index){
    if(index>1) {
      value = +Math.log(value);
      exportArr.push(value);
      if(value>maxExports){ maxExports = value; }
    }
  })
  return row;
}
var parseWars = function(row){
  row.Start = Number(row.Start);
  row.End = Number(row.Start);
}

d3.queue()
  .defer(d3.json, "world-110m.json")
  .defer(d3.csv, "imports.csv", parseImports)
  .defer(d3.csv, "exports.csv", parseExports)
  .defer(d3.csv, "wars.csv", parseWars)
  .await(function(error, rawCountries, rawImports, rawExports){

    importMap = d3.map(rawImports, function(country){ return country.ISO; });
    exportMap = d3.map(rawExports, function(country){ return country.ISO; });

    //scales are weird. What kind? What kind of min/max?
    //importScale = d3.scaleThreshold().domain(importArr).range(importColorScale);
    //exportScale = d3.scaleThreshold().domain(exportArr).range(exportColorScale);
    importScale = d3.scaleOrdinal().domain(importArr).range(importColorScale);
    exportScale = d3.scaleOrdinal().domain(exportArr).range(exportColorScale);


    countries = topojson.feature(rawCountries, rawCountries.objects.countries);

    //initialize to imports in 1960.
    showMap("imports", 1960);
  });

function showMap(type, year){
  buttonSelection = type;
  //set buttonselection to imports and yearinput to access csv variables
  var yearInput = "yr" + year;

  projection.fitExtent([[50,0], [mapWidth, height]], countries);
	pathGenerator = d3.geoPath().projection(projection);

  //make and fill map
	var paths = map.selectAll("path").data(countries.features);
	paths.enter().append("path").attr("class", "country")
	.merge(paths)
  .attr("fill", function (country){
    if(type=="imports"){
      var data = importMap.get(country.id);
      if (data) { return importScale(data[yearInput]); }
    }
    if(type=="exports"){
      var data = exportMap.get(country.id);
      if (data) { return exportScale(data[yearInput]); }
    }
  })
  .attr("stroke", "#888")
  .attr("d", function (country) {
    return pathGenerator(country);
  })
  .on("mouseover", function(country){
    if(type=="imports"){
      var data = importMap.get(country.id);
      
      document.getElementById("info").innerHTML = "Country: " + data.Country + "<br>" + "Year: " + year + "<br>" + "Import: $" + Math.round(data[yearInput] * 100)/100 + " worth of arms.";

      console.log("In " + year + ", " + data.Country + " imported $" + Math.round(data[yearInput] * 100)/100 + " worth of arms.")
    }
    if(type=="exports"){
      var data = exportMap.get(country.id);

      document.getElementById("info").innerHTML = "Country: " + data.Country + "<br>" + "Year: " + year + "<br>" + "Exports: $" + Math.round(data[yearInput] * 100)/100 + " worth of arms.";
      
      console.log("In " + year + ", " + data.Country + " exported $" + Math.round(data[yearInput] * 100)/100 + " worth of arms.")

    }
  });

  //remove the previous legend info, otherwise it gets overwritten and obscured
  d3.select("#legendText").remove();


  //remove old gradient color and add new one
  d3.select("#end").remove();
  if(type=="imports"){
    gradient.append("stop")
      .attr("id", "end")
      .attr("offset", "100%")
      .attr("stop-color", "#006699");
    legendLabels.append("text")
      .attr("id", "legendText")
      .attr("x", 30)
      .attr("y", 20)
      .text("Imports");
  }

  if(type=="exports"){
    gradient.append("stop")
      .attr("id", "end")
      .attr("offset", "100%")
      .attr("stop-color", "#990000");
    legendLabels.append("text")
      .attr("id", "legendText")
      .attr("x", 30)
      .attr("y", 20)
      .text("Exports");
  }

  gradientRect.attr("fill", "url(#gradient)");
}
//
function makeTimeline(){

}

</script>
</body>
</html>
